<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å½©ç¥¨éšæœºæ•°æ¨¡æ‹Ÿå™¨ï½œåŒè‰²çƒï¼ˆ6+1ï¼‰& å¤§ä¹é€ï¼ˆ5+2ï¼‰- å¸¦å»é‡åŠŸèƒ½</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#151a2e; --muted:#8a94b0; --fg:#e7eaf6; --accent:#6aa3ff;
      --red:#ff4d6d; --blue:#4dabf7; --green:#6ee7b7; --orange:#ffb454; --yellow:#ffd43b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:linear-gradient(120deg,#0f1220,#0d1524 60%,#0f1220);color:var(--fg)}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(20px,2.6vw,30px);margin:0;letter-spacing:.5px}
    .card{background:rgba(21,26,46,.8);backdrop-filter:blur(8px);border:1px solid #232949;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:14px;padding:18px}
    .group{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .seg{display:flex;background:#0e1330;border:1px solid #232949;border-radius:12px;overflow:hidden}
    .seg input{display:none}
    .seg label{padding:10px 14px;cursor:pointer;color:var(--muted);border-right:1px solid #232949;user-select:none}
    .seg label:last-child{border-right:none}
    .seg input:checked + label{background:linear-gradient(180deg,#1b2348,#131a37);color:#fff}
    .qty{display:flex;align-items:center;gap:8px}
    .qty input{width:80px;padding:10px;border-radius:10px;border:1px solid #2b3353;background:#0e1432;color:#fff}
    button{border:1px solid #2b3353;background:linear-gradient(180deg,#1c254c,#131a36);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .latest{margin-top:10px;padding:14px 18px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:36px;padding:0 10px;border-radius:999px;font-weight:600;box-shadow:inset 0 -2px rgba(0,0,0,.24)}
    .chip.red{background:radial-gradient(120% 120% at 20% 20%,#ff7a8e,#ff4d6d);}
    .chip.blue{background:radial-gradient(120% 120% at 20% 20%,#7ab7ff,#4dabf7);}
    .sep{opacity:.5}

    .history{margin-top:18px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{text-align:left;padding:12px 14px}
    thead th{color:var(--muted);font-weight:600}
    tbody tr{background:#121736;border:1px solid #232949}
    tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2b3353;background:#0e1432;color:#c8d1ff}
    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .ghost{background:transparent}
    .danger{border-color:#54303a;background:linear-gradient(180deg,#3a1b25,#2a1620)}
    .good{border-color:#2d4a41;background:linear-gradient(180deg,#1b3a33,#132a25)}
    .warning{border-color:#5a4a2d;background:linear-gradient(180deg,#3a3a1b,#2a2a16);color:var(--yellow)}
    .inline-actions{display:flex;gap:8px}
    footer{opacity:.7;font-size:12px;margin:22px 2px}

    /* å»é‡åŠŸèƒ½æ ·å¼ */
    .dedup-section{margin-top:16px;padding:18px;border-top:1px solid #232949}
    .upload-area{border:2px dashed #2b3353;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.3s}
    .upload-area:hover{border-color:var(--accent);background:rgba(106,163,255,0.05)}
    .upload-area.dragover{border-color:var(--green);background:rgba(110,231,183,0.1)}
    .file-input{display:none}
    .dedup-info{background:#0e1432;border:1px solid #2b3353;border-radius:8px;padding:12px;margin:12px 0}
    .status-indicator{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:16px}
    .status-indicator.active{background:var(--green);color:#000}
    .status-indicator.inactive{background:var(--muted);color:var(--bg)}

    @media (max-width:680px){
      .toolbar{grid-template-columns:1fr}
      .qty input{width:100%}
      .actions{justify-content:space-between}
      thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody tr{margin-bottom:10px}
      tbody tr td{display:flex;justify-content:space-between;align-items:center}
      tbody tr td::before{content:attr(data-label);font-weight:600;color:var(--muted)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ² å½©ç¥¨éšæœºæ•°æ¨¡æ‹Ÿå™¨ï½œåŒè‰²çƒï¼ˆ6+1ï¼‰& å¤§ä¹é€ï¼ˆ5+2ï¼‰</h1>
    </header>

    <section class="card">
      <div class="toolbar">
        <div class="group" aria-label="ç©æ³•é€‰æ‹©">
          <div class="seg" role="tablist" aria-label="game selector">
            <input id="game-ssq" type="radio" name="game" value="ssq" checked>
            <label for="game-ssq">åŒè‰²çƒï¼ˆ6+1ï¼‰</label>
            <input id="game-dlt" type="radio" name="game" value="dlt">
            <label for="game-dlt">å¤§ä¹é€ï¼ˆ5+2ï¼‰</label>
          </div>
          <span class="small">åŒè‰²çƒï¼šçº¢çƒ1-33 é€‰6ï¼›è“çƒ1-16 é€‰1ã€‚å¤§ä¹é€ï¼šå‰åŒº1-35 é€‰5ï¼›ååŒº1-12 é€‰2ã€‚</span>
        </div>
        <div class="group" style="justify-content:flex-end">
          <div class="qty">
            <label for="count" class="muted">ç”Ÿæˆæ³¨æ•°</label>
            <input id="count" type="number" min="1" max="50" step="1" value="1">
            <button id="btn-generate">ç”Ÿæˆéšæœºå·ç </button>
          </div>
        </div>
      </div>

      <!-- å»é‡åŠŸèƒ½åŒºåŸŸ -->
      <div class="dedup-section">
        <div class="group" style="justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <span class="muted">å·ç å»é‡åŠŸèƒ½</span>
            <span class="status-indicator" id="dedup-status">
              <span>â—</span> æœªå¯ç”¨
            </span>
          </div>
          <div class="actions">
            <button id="btn-toggle-dedup" class="ghost">å¯ç”¨å»é‡</button>
            <button id="btn-clear-dedup" class="ghost">æ¸…ç©ºæ•°æ®åº“</button>
          </div>
        </div>
        
        <div class="upload-area" id="upload-area" style="display:none">
          <input type="file" id="file-input" class="file-input" accept=".csv,.txt,.json" multiple>
          <div>
            <p>ğŸ“ æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <p class="small">æ”¯æŒ CSVã€TXTã€JSON æ ¼å¼ï¼Œå¯é€‰æ‹©å¤šä¸ªæ–‡ä»¶</p>
          </div>
        </div>

        <div class="dedup-info" id="dedup-info" style="display:none">
          <div class="small">
            <div>ğŸ“Š æ•°æ®åº“çŠ¶æ€ï¼š<span id="db-count">0</span> æ¡è®°å½•</div>
            <div>ğŸ¯ å»é‡æ¨¡å¼ï¼š<span id="dedup-mode">å®Œå…¨åŒ¹é…</span></div>
            <div>ğŸ“ æ”¯æŒæ ¼å¼ï¼šçº¢çƒå·ç ç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”ï¼Œè“çƒå·ç ç”¨ + å·åˆ†éš”</div>
            <div class="small muted">ç¤ºä¾‹ï¼š01 02 03 04 05 06+07 æˆ– 1,2,3,4,5,6+7</div>
          </div>
        </div>
      </div>

      <div class="latest">
        <div class="row">
          <div class="tag" id="tag-game">å½“å‰ç©æ³•ï¼šåŒè‰²çƒ</div>
          <div class="chips" id="latest-chips" aria-live="polite"></div>
          <span class="sep">&nbsp;</span>
          <div class="inline-actions">
            <button id="btn-copy" class="ghost" title="å¤åˆ¶æœ€æ–°ç»“æœ">å¤åˆ¶</button>
            <button id="btn-save" class="good" title="å°†æœ€æ–°ç»“æœä¿å­˜åˆ°è®°å½•">ä¿å­˜è®°å½•</button>
          </div>
        </div>
      </div>
    </section>

    <section class="history">
      <div class="group" style="justify-content:space-between;align-items:center;margin:8px 4px">
        <div class="muted">å†å²è®°å½•ï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</div>
        <div class="actions">
          <button id="btn-export-json" class="ghost">å¯¼å‡º JSON</button>
          <button id="btn-export-csv" class="ghost">å¯¼å‡º CSV</button>
          <button id="btn-clear" class="danger">æ¸…ç©ºè®°å½•</button>
        </div>
      </div>
      <div class="card" style="padding:10px 14px">
        <table>
          <thead>
            <tr>
              <th style="width:120px">æ—¶é—´</th>
              <th style="width:120px">ç©æ³•</th>
              <th>å·ç </th>
              <th style="width:160px">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <footer>æç¤ºï¼šè®°å½•ä»…ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚å»é‡æ•°æ®åº“åŒæ ·ä¿å­˜åœ¨æœ¬åœ°ã€‚</footer>
  </div>

  <script>
    // ===== å·¥å…·å‡½æ•° =====
    const pad2 = n => String(n).padStart(2, '0');
    const sample = (n, k) => {
      const arr = Array.from({length:n}, (_,i)=>i+1);
      for (let i=arr.length-1;i>0;i--) {
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr.slice(0,k).sort((a,b)=>a-b);
    };
    const nowTS = () => new Date().toISOString();

    // ===== å»é‡æ•°æ®åº“ =====
    const DEDUP_KEY = 'lottoDedupDB.v1';
    let dedupEnabled = false;
    let dedupDatabase = new Set();

    function loadDedupDB(){
      try{ 
        const data = JSON.parse(localStorage.getItem(DEDUP_KEY)) || [];
        return new Set(data);
      }catch{ 
        return new Set(); 
      }
    }

    function saveDedupDB(){
      localStorage.setItem(DEDUP_KEY, JSON.stringify([...dedupDatabase]));
      updateDedupInfo();
    }

    function updateDedupInfo(){
      document.getElementById('db-count').textContent = dedupDatabase.size;
      const status = document.getElementById('dedup-status');
      const toggleBtn = document.getElementById('btn-toggle-dedup');
      
      if(dedupEnabled){
        status.innerHTML = '<span>â—</span> å·²å¯ç”¨';
        status.className = 'status-indicator active';
        toggleBtn.textContent = 'ç¦ç”¨å»é‡';
        document.getElementById('upload-area').style.display = 'block';
        document.getElementById('dedup-info').style.display = 'block';
      } else {
        status.innerHTML = '<span>â—</span> æœªå¯ç”¨';
        status.className = 'status-indicator inactive';
        toggleBtn.textContent = 'å¯ç”¨å»é‡';
        document.getElementById('upload-area').style.display = 'none';
        document.getElementById('dedup-info').style.display = 'none';
      }
    }

    function normalizeNumber(set){
      // æ ‡å‡†åŒ–å·ç æ ¼å¼ç”¨äºå»é‡æ¯”è¾ƒ
      if(set.game === 'ssq'){
        return `${set.reds.map(n=>pad2(n)).join(',')}-${set.blues.map(n=>pad2(n)).join(',')}`;
      } else {
        return `${set.reds.map(n=>pad2(n)).join(',')}-${set.blues.map(n=>pad2(n)).join(',')}`;
      }
    }

    function parseNumberString(str, game){
      // è§£æå„ç§æ ¼å¼çš„å·ç å­—ç¬¦ä¸²
      try {
        // å»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œ
        str = str.trim().replace(/\s+/g, ' ');
        
        // æ”¯æŒå¤šç§åˆ†éš”ç¬¦æ ¼å¼
        let parts;
        if(str.includes('+')){
          parts = str.split('+');
        } else if(str.includes('-')){
          parts = str.split('-');
        } else if(str.includes('|')){
          parts = str.split('|');
        } else {
          return null; // æ— æ³•è¯†åˆ«æ ¼å¼
        }

        if(parts.length !== 2) return null;

        // è§£æçº¢çƒ/å‰åŒº
        const reds = parts[0].split(/[,\s]+/).filter(x=>x).map(x=>parseInt(x.replace(/\D/g,''),10)).filter(x=>x>0);
        // è§£æè“çƒ/ååŒº  
        const blues = parts[1].split(/[,\s]+/).filter(x=>x).map(x=>parseInt(x.replace(/\D/g,''),10)).filter(x=>x>0);

        // éªŒè¯å·ç æ•°é‡
        if(game === 'ssq' && (reds.length !== 6 || blues.length !== 1)) return null;
        if(game === 'dlt' && (reds.length !== 5 || blues.length !== 2)) return null;

        return { game, reds: reds.sort((a,b)=>a-b), blues: blues.sort((a,b)=>a-b) };
      } catch {
        return null;
      }
    }

    function addToDedupDB(numberStr){
      if(numberStr && typeof numberStr === 'string'){
        dedupDatabase.add(numberStr.trim());
      }
    }

    // ===== å·ç ç”Ÿæˆï¼ˆå¸¦å»é‡ï¼‰ =====
    function genSSQ(){
      let attempts = 0;
      const maxAttempts = 1000; // é˜²æ­¢æ— é™å¾ªç¯
      
      while(attempts < maxAttempts){
        const reds = sample(33,6);
        const blue = sample(16,1);
        const set = { game:'ssq', reds, blues: blue };
        
        if(!dedupEnabled || !dedupDatabase.has(normalizeNumber(set))){
          return set;
        }
        attempts++;
      }
      
      // å¦‚æœå°è¯•1000æ¬¡éƒ½é‡å¤ï¼Œè¿”å›ä¸€ä¸ªéšæœºçš„ä½†æ ‡è®°ä¸ºå¯èƒ½é‡å¤
      const reds = sample(33,6);
      const blue = sample(16,1);
      const set = { game:'ssq', reds, blues: blue, mayDuplicate: true };
      return set;
    }

    function genDLT(){
      let attempts = 0;
      const maxAttempts = 1000;
      
      while(attempts < maxAttempts){
        const front = sample(35,5);
        const back = sample(12,2);
        const set = { game:'dlt', reds: front, blues: back };
        
        if(!dedupEnabled || !dedupDatabase.has(normalizeNumber(set))){
          return set;
        }
        attempts++;
      }
      
      const front = sample(35,5);
      const back = sample(12,2);
      const set = { game:'dlt', reds: front, blues: back, mayDuplicate: true };
      return set;
    }

    function formatSet(set){
      const prefix = set.mayDuplicate ? 'âš ï¸ ' : '';
      if(set.game==='ssq'){
        return `${prefix}çº¢: ${set.reds.map(pad2).join(' ')} + è“: ${[].concat(set.blues).map(pad2).join(' ')}`;
      }else{
        return `${prefix}å‰: ${set.reds.map(pad2).join(' ')} + å: ${[].concat(set.blues).map(pad2).join(' ')}`;
      }
    }

    // ===== UI æ¸²æŸ“ =====
    const latestChips = document.querySelector('#latest-chips');
    const tagGame = document.querySelector('#tag-game');
    const tbody = document.querySelector('#tbody');

    function renderLatest(set){
      latestChips.innerHTML = '';
      const reds = set.reds.map(n=>`<span class="chip red">${pad2(n)}</span>`).join('');
      const blues = ([]).concat(set.blues).map(n=>`<span class="chip blue">${pad2(n)}</span>`).join('');
      
      // å¦‚æœå¯èƒ½é‡å¤ï¼Œæ·»åŠ è­¦å‘Šæ ·å¼
      const warning = set.mayDuplicate ? '<span class="chip warning" title="å¯èƒ½ä¸æ•°æ®åº“é‡å¤">âš ï¸</span>' : '';
      
      latestChips.insertAdjacentHTML('beforeend', warning + reds + `<span class="sep"></span>` + blues);
      tagGame.textContent = 'å½“å‰ç©æ³•ï¼š' + (set.game==='ssq' ? 'åŒè‰²çƒ' : 'å¤§ä¹é€');
    }

    function rowHTML(rec, idx){
      const warningIcon = rec.mayDuplicate ? '<span class="chip warning" style="font-size:10px">âš ï¸</span>' : '';
      return `<tr data-idx="${idx}">
        <td data-label="æ—¶é—´"><span class="small">${new Date(rec.time).toLocaleString()}</span></td>
        <td data-label="ç©æ³•">${rec.game==='ssq' ? 'åŒè‰²çƒ' : 'å¤§ä¹é€'}</td>
        <td data-label="å·ç ">
          <div class="chips">${warningIcon}${rec.reds.map(n=>`<span class=\"chip red\">${pad2(n)}</span>`).join('')}<span class="sep"></span>${[].concat(rec.blues).map(n=>`<span class=\"chip blue\">${pad2(n)}</span>`).join('')}</div>
          <div class="small">${formatSet(rec)}</div>
        </td>
        <td data-label="æ“ä½œ">
          <div class="inline-actions">
            <button class="ghost btn-copy-one">å¤åˆ¶</button>
            <button class="ghost btn-del">åˆ é™¤</button>
          </div>
        </td>
      </tr>`;
    }

    // ===== å­˜å‚¨ï¼ˆlocalStorageï¼‰ =====
    const KEY = 'lottoHistory.v1';
    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; }
    }
    function saveHistory(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

    function pushRecord(rec){
      const list = loadHistory();
      list.unshift(rec);
      saveHistory(list);
      renderTable();
      
      // è‡ªåŠ¨æ·»åŠ åˆ°å»é‡æ•°æ®åº“
      if(dedupEnabled){
        addToDedupDB(normalizeNumber(rec));
        saveDedupDB();
      }
    }

    function renderTable(){
      const list = loadHistory();
      tbody.innerHTML = list.map((rec,i)=>rowHTML(rec,i)).join('');
    }

    // ===== æ–‡ä»¶å¤„ç† =====
    function processFile(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e){
          try {
            const content = e.target.result;
            const lines = content.split('\n').map(line => line.trim()).filter(line => line);
            let processed = 0;
            
            const currentGame = document.getElementById('game-ssq').checked ? 'ssq' : 'dlt';
            
            for(const line of lines){
              const parsed = parseNumberString(line, currentGame);
              if(parsed){
                const normalized = normalizeNumber(parsed);
                addToDedupDB(normalized);
                processed++;
              }
            }
            
            resolve(processed);
          } catch(err) {
            reject(err);
          }
        };
        reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
        reader.readAsText(file, 'utf-8');
      });
    }

    // ===== å¯¼å‡º =====
    function exportJSON(){
      const blob = new Blob([JSON.stringify(loadHistory(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `lotto-history-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function exportCSV(){
      const rows = [['time','game','reds','blues','formatted','mayDuplicate']];
      for(const r of loadHistory()){
        rows.push([
          r.time,
          r.game,
          r.reds.map(pad2).join(' '),
          ([]).concat(r.blues).map(pad2).join(' '),
          formatSet(r),
          r.mayDuplicate || false
        ]);
      }
      const csv = rows.map(r=>r.map(cell=>`"${String(cell).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `lotto-history-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ===== äº‹ä»¶ç»‘å®š =====
    let currentSet = genSSQ();
    
    // åˆå§‹åŒ–å»é‡æ•°æ®åº“
    dedupDatabase = loadDedupDB();
    updateDedupInfo();
    
    renderLatest(currentSet);
    renderTable();

    const $ = sel => document.querySelector(sel);

    $('#game-ssq').addEventListener('change', ()=>{
      currentSet = genSSQ();
      renderLatest(currentSet);
    });
    $('#game-dlt').addEventListener('change', ()=>{
      currentSet = genDLT();
      renderLatest(currentSet);
    });

    $('#btn-generate').addEventListener('click', ()=>{
      const n = Math.max(1, Math.min(50, parseInt($('#count').value||'1',10)));
      const isSSQ = $('#game-ssq').checked;
      let last=null;
      for(let i=0;i<n;i++){
        last = isSSQ ? genSSQ() : genDLT();
        renderLatest(last);
        pushRecord({...last, time: nowTS()});
      }
      currentSet = last;
    });

    $('#btn-save').addEventListener('click', ()=>{
      pushRecord({...currentSet, time: nowTS()});
    });

    $('#btn-copy').addEventListener('click', async ()=>{
      const text = formatSet(currentSet);
      try{ await navigator.clipboard.writeText(text); alert('å·²å¤åˆ¶ï¼š'+text); }catch{ alert(text); }
    });

    // å»é‡åŠŸèƒ½äº‹ä»¶
    $('#btn-toggle-dedup').addEventListener('click', ()=>{
      dedupEnabled = !dedupEnabled;
      updateDedupInfo();
      
      // é‡æ–°ç”Ÿæˆå½“å‰å·ç 
      const isSSQ = $('#game-ssq').checked;
      currentSet = isSSQ ? genSSQ() : genDLT();
      renderLatest(currentSet);
    });

    $('#btn-clear-dedup').addEventListener('click', ()=>{
      if(confirm('ç¡®è®¤æ¸…ç©ºå»é‡æ•°æ®åº“ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')){
        dedupDatabase.clear();
        saveDedupDB();
      }
    });

    // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
    const uploadArea = $('#upload-area');
    const fileInput = $('#file-input');

    uploadArea.addEventListener('click', ()=> fileInput.click());

    uploadArea.addEventListener('dragover', (e)=>{
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', ()=>{
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', async (e)=>{
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = [...e.dataTransfer.files];
      await processFiles(files);
    });

    fileInput.addEventListener('change', async (e)=>{
      const files = [...e.target.files];
      await processFiles(files);
    });

    async function processFiles(files){
      let totalProcessed = 0;
      
      for(const file of files){
        try {
          const processed = await processFile(file);
          totalProcessed += processed;
        } catch(err) {
          console.error('å¤„ç†æ–‡ä»¶å¤±è´¥:', file.name, err);
        }
      }
      
      if(totalProcessed > 0){
        saveDedupDB();
        alert(`æˆåŠŸå¯¼å…¥ ${totalProcessed} æ¡è®°å½•åˆ°å»é‡æ•°æ®åº“`);
      } else {
        alert('æœªèƒ½è¯†åˆ«æœ‰æ•ˆçš„å·ç æ•°æ®');
      }
    }

    $('#btn-export-json').addEventListener('click', exportJSON);
    $('#btn-export-csv').addEventListener('click', exportCSV);

    $('#btn-clear').addEventListener('click', ()=>{
      if(confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')){ saveHistory([]); renderTable(); }
    });

    tbody.addEventListener('click', async (e)=>{
      const tr = e.target.closest('tr');
      if(!tr) return;
      const idx = parseInt(tr.dataset.idx,10);
      const list = loadHistory();
      if(e.target.classList.contains('btn-del')){
        list.splice(idx,1); saveHistory(list); renderTable();
      } else if(e.target.classList.contains('btn-copy-one')){
        const rec = list[idx];
        const text = formatSet(rec);
        try{ await navigator.clipboard.writeText(text); alert('å·²å¤åˆ¶ï¼š'+text); }catch{ alert(text); }
      }
    });
  </script>
</body>
</html>
