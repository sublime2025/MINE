<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>彩票随机数模拟器｜双色球（6+1）& 大乐透（5+2）- 带去重功能</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#151a2e; --muted:#8a94b0; --fg:#e7eaf6; --accent:#6aa3ff;
      --red:#ff4d6d; --blue:#4dabf7; --green:#6ee7b7; --orange:#ffb454; --yellow:#ffd43b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:linear-gradient(120deg,#0f1220,#0d1524 60%,#0f1220);color:var(--fg)}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(20px,2.6vw,30px);margin:0;letter-spacing:.5px}
    .card{background:rgba(21,26,46,.8);backdrop-filter:blur(8px);border:1px solid #232949;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:14px;padding:18px}
    .group{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .seg{display:flex;background:#0e1330;border:1px solid #232949;border-radius:12px;overflow:hidden}
    .seg input{display:none}
    .seg label{padding:10px 14px;cursor:pointer;color:var(--muted);border-right:1px solid #232949;user-select:none}
    .seg label:last-child{border-right:none}
    .seg input:checked + label{background:linear-gradient(180deg,#1b2348,#131a37);color:#fff}
    .qty{display:flex;align-items:center;gap:8px}
    .qty input{width:80px;padding:10px;border-radius:10px;border:1px solid #2b3353;background:#0e1432;color:#fff}
    button{border:1px solid #2b3353;background:linear-gradient(180deg,#1c254c,#131a36);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .latest{margin-top:10px;padding:14px 18px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:36px;padding:0 10px;border-radius:999px;font-weight:600;box-shadow:inset 0 -2px rgba(0,0,0,.24)}
    .chip.red{background:radial-gradient(120% 120% at 20% 20%,#ff7a8e,#ff4d6d);}
    .chip.blue{background:radial-gradient(120% 120% at 20% 20%,#7ab7ff,#4dabf7);}
    .sep{opacity:.5}

    .history{margin-top:18px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{text-align:left;padding:12px 14px}
    thead th{color:var(--muted);font-weight:600}
    tbody tr{background:#121736;border:1px solid #232949}
    tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2b3353;background:#0e1432;color:#c8d1ff}
    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .ghost{background:transparent}
    .danger{border-color:#54303a;background:linear-gradient(180deg,#3a1b25,#2a1620)}
    .good{border-color:#2d4a41;background:linear-gradient(180deg,#1b3a33,#132a25)}
    .warning{border-color:#5a4a2d;background:linear-gradient(180deg,#3a3a1b,#2a2a16);color:var(--yellow)}
    .inline-actions{display:flex;gap:8px}
    footer{opacity:.7;font-size:12px;margin:22px 2px}

    /* 去重功能样式 */
    .dedup-section{margin-top:16px;padding:18px;border-top:1px solid #232949}
    .upload-area{border:2px dashed #2b3353;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.3s}
    .upload-area:hover{border-color:var(--accent);background:rgba(106,163,255,0.05)}
    .upload-area.dragover{border-color:var(--green);background:rgba(110,231,183,0.1)}
    .file-input{display:none}
    .dedup-info{background:#0e1432;border:1px solid #2b3353;border-radius:8px;padding:12px;margin:12px 0}
    .status-indicator{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:16px}
    .status-indicator.active{background:var(--green);color:#000}
    .status-indicator.inactive{background:var(--muted);color:var(--bg)}

    @media (max-width:680px){
      .toolbar{grid-template-columns:1fr}
      .qty input{width:100%}
      .actions{justify-content:space-between}
      thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody tr{margin-bottom:10px}
      tbody tr td{display:flex;justify-content:space-between;align-items:center}
      tbody tr td::before{content:attr(data-label);font-weight:600;color:var(--muted)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>🎲 彩票随机数模拟器｜双色球（6+1）& 大乐透（5+2）</h1>
    </header>

    <section class="card">
      <div class="toolbar">
        <div class="group" aria-label="玩法选择">
          <div class="seg" role="tablist" aria-label="game selector">
            <input id="game-ssq" type="radio" name="game" value="ssq" checked>
            <label for="game-ssq">双色球（6+1）</label>
            <input id="game-dlt" type="radio" name="game" value="dlt">
            <label for="game-dlt">大乐透（5+2）</label>
          </div>
          <span class="small">双色球：红球1-33 选6；蓝球1-16 选1。大乐透：前区1-35 选5；后区1-12 选2。</span>
        </div>
        <div class="group" style="justify-content:flex-end">
          <div class="qty">
            <label for="count" class="muted">生成注数</label>
            <input id="count" type="number" min="1" max="50" step="1" value="1">
            <button id="btn-generate">生成随机号码</button>
          </div>
        </div>
      </div>

      <!-- 去重功能区域 -->
      <div class="dedup-section">
        <div class="group" style="justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <span class="muted">号码去重功能</span>
            <span class="status-indicator" id="dedup-status">
              <span>●</span> 未启用
            </span>
          </div>
          <div class="actions">
            <button id="btn-toggle-dedup" class="ghost">启用去重</button>
            <button id="btn-clear-dedup" class="ghost">清空数据库</button>
          </div>
        </div>
        
        <div class="upload-area" id="upload-area" style="display:none">
          <input type="file" id="file-input" class="file-input" accept=".csv,.txt,.json" multiple>
          <div>
            <p>📁 拖拽文件到此处或点击选择文件</p>
            <p class="small">支持 CSV、TXT、JSON 格式，可选择多个文件</p>
          </div>
        </div>

        <div class="dedup-info" id="dedup-info" style="display:none">
          <div class="small">
            <div>📊 数据库状态：<span id="db-count">0</span> 条记录</div>
            <div>🎯 去重模式：<span id="dedup-mode">完全匹配</span></div>
            <div>📝 支持格式：红球号码用空格或逗号分隔，蓝球号码用 + 号分隔</div>
            <div class="small muted">示例：01 02 03 04 05 06+07 或 1,2,3,4,5,6+7</div>
          </div>
        </div>
      </div>

      <div class="latest">
        <div class="row">
          <div class="tag" id="tag-game">当前玩法：双色球</div>
          <div class="chips" id="latest-chips" aria-live="polite"></div>
          <span class="sep">&nbsp;</span>
          <div class="inline-actions">
            <button id="btn-copy" class="ghost" title="复制最新结果">复制</button>
            <button id="btn-save" class="good" title="将最新结果保存到记录">保存记录</button>
          </div>
        </div>
      </div>
    </section>

    <section class="history">
      <div class="group" style="justify-content:space-between;align-items:center;margin:8px 4px">
        <div class="muted">历史记录（本地保存）</div>
        <div class="actions">
          <button id="btn-export-json" class="ghost">导出 JSON</button>
          <button id="btn-export-csv" class="ghost">导出 CSV</button>
          <button id="btn-clear" class="danger">清空记录</button>
        </div>
      </div>
      <div class="card" style="padding:10px 14px">
        <table>
          <thead>
            <tr>
              <th style="width:120px">时间</th>
              <th style="width:120px">玩法</th>
              <th>号码</th>
              <th style="width:160px">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <footer>提示：记录仅保存在您的浏览器中，不会上传到服务器。去重数据库同样保存在本地。</footer>
  </div>

  <script>
    // ===== 工具函数 =====
    const pad2 = n => String(n).padStart(2, '0');
    const sample = (n, k) => {
      const arr = Array.from({length:n}, (_,i)=>i+1);
      for (let i=arr.length-1;i>0;i--) {
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr.slice(0,k).sort((a,b)=>a-b);
    };
    const nowTS = () => new Date().toISOString();

    // ===== 去重数据库 =====
    const DEDUP_KEY = 'lottoDedupDB.v1';
    let dedupEnabled = false;
    let dedupDatabase = new Set();

    function loadDedupDB(){
      try{ 
        const data = JSON.parse(localStorage.getItem(DEDUP_KEY)) || [];
        return new Set(data);
      }catch{ 
        return new Set(); 
      }
    }

    function saveDedupDB(){
      localStorage.setItem(DEDUP_KEY, JSON.stringify([...dedupDatabase]));
      updateDedupInfo();
    }

    function updateDedupInfo(){
      document.getElementById('db-count').textContent = dedupDatabase.size;
      const status = document.getElementById('dedup-status');
      const toggleBtn = document.getElementById('btn-toggle-dedup');
      
      if(dedupEnabled){
        status.innerHTML = '<span>●</span> 已启用';
        status.className = 'status-indicator active';
        toggleBtn.textContent = '禁用去重';
        document.getElementById('upload-area').style.display = 'block';
        document.getElementById('dedup-info').style.display = 'block';
      } else {
        status.innerHTML = '<span>●</span> 未启用';
        status.className = 'status-indicator inactive';
        toggleBtn.textContent = '启用去重';
        document.getElementById('upload-area').style.display = 'none';
        document.getElementById('dedup-info').style.display = 'none';
      }
    }

    function normalizeNumber(set){
      // 标准化号码格式用于去重比较
      if(set.game === 'ssq'){
        return `${set.reds.map(n=>pad2(n)).join(',')}-${set.blues.map(n=>pad2(n)).join(',')}`;
      } else {
        return `${set.reds.map(n=>pad2(n)).join(',')}-${set.blues.map(n=>pad2(n)).join(',')}`;
      }
    }

    function parseNumberString(str, game){
      // 解析各种格式的号码字符串
      try {
        // 去除多余空格和换行
        str = str.trim().replace(/\s+/g, ' ');
        
        // 支持多种分隔符格式
        let parts;
        if(str.includes('+')){
          parts = str.split('+');
        } else if(str.includes('-')){
          parts = str.split('-');
        } else if(str.includes('|')){
          parts = str.split('|');
        } else {
          return null; // 无法识别格式
        }

        if(parts.length !== 2) return null;

        // 解析红球/前区
        const reds = parts[0].split(/[,\s]+/).filter(x=>x).map(x=>parseInt(x.replace(/\D/g,''),10)).filter(x=>x>0);
        // 解析蓝球/后区  
        const blues = parts[1].split(/[,\s]+/).filter(x=>x).map(x=>parseInt(x.replace(/\D/g,''),10)).filter(x=>x>0);

        // 验证号码数量
        if(game === 'ssq' && (reds.length !== 6 || blues.length !== 1)) return null;
        if(game === 'dlt' && (reds.length !== 5 || blues.length !== 2)) return null;

        return { game, reds: reds.sort((a,b)=>a-b), blues: blues.sort((a,b)=>a-b) };
      } catch {
        return null;
      }
    }

    function addToDedupDB(numberStr){
      if(numberStr && typeof numberStr === 'string'){
        dedupDatabase.add(numberStr.trim());
      }
    }

    // ===== 号码生成（带去重） =====
    function genSSQ(){
      let attempts = 0;
      const maxAttempts = 1000; // 防止无限循环
      
      while(attempts < maxAttempts){
        const reds = sample(33,6);
        const blue = sample(16,1);
        const set = { game:'ssq', reds, blues: blue };
        
        if(!dedupEnabled || !dedupDatabase.has(normalizeNumber(set))){
          return set;
        }
        attempts++;
      }
      
      // 如果尝试1000次都重复，返回一个随机的但标记为可能重复
      const reds = sample(33,6);
      const blue = sample(16,1);
      const set = { game:'ssq', reds, blues: blue, mayDuplicate: true };
      return set;
    }

    function genDLT(){
      let attempts = 0;
      const maxAttempts = 1000;
      
      while(attempts < maxAttempts){
        const front = sample(35,5);
        const back = sample(12,2);
        const set = { game:'dlt', reds: front, blues: back };
        
        if(!dedupEnabled || !dedupDatabase.has(normalizeNumber(set))){
          return set;
        }
        attempts++;
      }
      
      const front = sample(35,5);
      const back = sample(12,2);
      const set = { game:'dlt', reds: front, blues: back, mayDuplicate: true };
      return set;
    }

    function formatSet(set){
      const prefix = set.mayDuplicate ? '⚠️ ' : '';
      if(set.game==='ssq'){
        return `${prefix}红: ${set.reds.map(pad2).join(' ')} + 蓝: ${[].concat(set.blues).map(pad2).join(' ')}`;
      }else{
        return `${prefix}前: ${set.reds.map(pad2).join(' ')} + 后: ${[].concat(set.blues).map(pad2).join(' ')}`;
      }
    }

    // ===== UI 渲染 =====
    const latestChips = document.querySelector('#latest-chips');
    const tagGame = document.querySelector('#tag-game');
    const tbody = document.querySelector('#tbody');

    function renderLatest(set){
      latestChips.innerHTML = '';
      const reds = set.reds.map(n=>`<span class="chip red">${pad2(n)}</span>`).join('');
      const blues = ([]).concat(set.blues).map(n=>`<span class="chip blue">${pad2(n)}</span>`).join('');
      
      // 如果可能重复，添加警告样式
      const warning = set.mayDuplicate ? '<span class="chip warning" title="可能与数据库重复">⚠️</span>' : '';
      
      latestChips.insertAdjacentHTML('beforeend', warning + reds + `<span class="sep"></span>` + blues);
      tagGame.textContent = '当前玩法：' + (set.game==='ssq' ? '双色球' : '大乐透');
    }

    function rowHTML(rec, idx){
      const warningIcon = rec.mayDuplicate ? '<span class="chip warning" style="font-size:10px">⚠️</span>' : '';
      return `<tr data-idx="${idx}">
        <td data-label="时间"><span class="small">${new Date(rec.time).toLocaleString()}</span></td>
        <td data-label="玩法">${rec.game==='ssq' ? '双色球' : '大乐透'}</td>
        <td data-label="号码">
          <div class="chips">${warningIcon}${rec.reds.map(n=>`<span class=\"chip red\">${pad2(n)}</span>`).join('')}<span class="sep"></span>${[].concat(rec.blues).map(n=>`<span class=\"chip blue\">${pad2(n)}</span>`).join('')}</div>
          <div class="small">${formatSet(rec)}</div>
        </td>
        <td data-label="操作">
          <div class="inline-actions">
            <button class="ghost btn-copy-one">复制</button>
            <button class="ghost btn-del">删除</button>
          </div>
        </td>
      </tr>`;
    }

    // ===== 存储（localStorage） =====
    const KEY = 'lottoHistory.v1';
    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; }
    }
    function saveHistory(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

    function pushRecord(rec){
      const list = loadHistory();
      list.unshift(rec);
      saveHistory(list);
      renderTable();
      
      // 自动添加到去重数据库
      if(dedupEnabled){
        addToDedupDB(normalizeNumber(rec));
        saveDedupDB();
      }
    }

    function renderTable(){
      const list = loadHistory();
      tbody.innerHTML = list.map((rec,i)=>rowHTML(rec,i)).join('');
    }

    // ===== 文件处理 =====
    function processFile(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e){
          try {
            const content = e.target.result;
            const lines = content.split('\n').map(line => line.trim()).filter(line => line);
            let processed = 0;
            
            const currentGame = document.getElementById('game-ssq').checked ? 'ssq' : 'dlt';
            
            for(const line of lines){
              const parsed = parseNumberString(line, currentGame);
              if(parsed){
                const normalized = normalizeNumber(parsed);
                addToDedupDB(normalized);
                processed++;
              }
            }
            
            resolve(processed);
          } catch(err) {
            reject(err);
          }
        };
        reader.onerror = () => reject(new Error('文件读取失败'));
        reader.readAsText(file, 'utf-8');
      });
    }

    // ===== 导出 =====
    function exportJSON(){
      const blob = new Blob([JSON.stringify(loadHistory(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `lotto-history-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function exportCSV(){
      const rows = [['time','game','reds','blues','formatted','mayDuplicate']];
      for(const r of loadHistory()){
        rows.push([
          r.time,
          r.game,
          r.reds.map(pad2).join(' '),
          ([]).concat(r.blues).map(pad2).join(' '),
          formatSet(r),
          r.mayDuplicate || false
        ]);
      }
      const csv = rows.map(r=>r.map(cell=>`"${String(cell).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `lotto-history-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ===== 事件绑定 =====
    let currentSet = genSSQ();
    
    // 初始化去重数据库
    dedupDatabase = loadDedupDB();
    updateDedupInfo();
    
    renderLatest(currentSet);
    renderTable();

    const $ = sel => document.querySelector(sel);

    $('#game-ssq').addEventListener('change', ()=>{
      currentSet = genSSQ();
      renderLatest(currentSet);
    });
    $('#game-dlt').addEventListener('change', ()=>{
      currentSet = genDLT();
      renderLatest(currentSet);
    });

    $('#btn-generate').addEventListener('click', ()=>{
      const n = Math.max(1, Math.min(50, parseInt($('#count').value||'1',10)));
      const isSSQ = $('#game-ssq').checked;
      let last=null;
      for(let i=0;i<n;i++){
        last = isSSQ ? genSSQ() : genDLT();
        renderLatest(last);
        pushRecord({...last, time: nowTS()});
      }
      currentSet = last;
    });

    $('#btn-save').addEventListener('click', ()=>{
      pushRecord({...currentSet, time: nowTS()});
    });

    $('#btn-copy').addEventListener('click', async ()=>{
      const text = formatSet(currentSet);
      try{ await navigator.clipboard.writeText(text); alert('已复制：'+text); }catch{ alert(text); }
    });

    // 去重功能事件
    $('#btn-toggle-dedup').addEventListener('click', ()=>{
      dedupEnabled = !dedupEnabled;
      updateDedupInfo();
      
      // 重新生成当前号码
      const isSSQ = $('#game-ssq').checked;
      currentSet = isSSQ ? genSSQ() : genDLT();
      renderLatest(currentSet);
    });

    $('#btn-clear-dedup').addEventListener('click', ()=>{
      if(confirm('确认清空去重数据库？此操作不可恢复。')){
        dedupDatabase.clear();
        saveDedupDB();
      }
    });

    // 文件上传事件
    const uploadArea = $('#upload-area');
    const fileInput = $('#file-input');

    uploadArea.addEventListener('click', ()=> fileInput.click());

    uploadArea.addEventListener('dragover', (e)=>{
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', ()=>{
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', async (e)=>{
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = [...e.dataTransfer.files];
      await processFiles(files);
    });

    fileInput.addEventListener('change', async (e)=>{
      const files = [...e.target.files];
      await processFiles(files);
    });

    async function processFiles(files){
      let totalProcessed = 0;
      
      for(const file of files){
        try {
          const processed = await processFile(file);
          totalProcessed += processed;
        } catch(err) {
          console.error('处理文件失败:', file.name, err);
        }
      }
      
      if(totalProcessed > 0){
        saveDedupDB();
        alert(`成功导入 ${totalProcessed} 条记录到去重数据库`);
      } else {
        alert('未能识别有效的号码数据');
      }
    }

    $('#btn-export-json').addEventListener('click', exportJSON);
    $('#btn-export-csv').addEventListener('click', exportCSV);

    $('#btn-clear').addEventListener('click', ()=>{
      if(confirm('确认清空所有历史记录？此操作不可恢复。')){ saveHistory([]); renderTable(); }
    });

    tbody.addEventListener('click', async (e)=>{
      const tr = e.target.closest('tr');
      if(!tr) return;
      const idx = parseInt(tr.dataset.idx,10);
      const list = loadHistory();
      if(e.target.classList.contains('btn-del')){
        list.splice(idx,1); saveHistory(list); renderTable();
      } else if(e.target.classList.contains('btn-copy-one')){
        const rec = list[idx];
        const text = formatSet(rec);
        try{ await navigator.clipboard.writeText(text); alert('已复制：'+text); }catch{ alert(text); }
      }
    });
  </script>
</body>
</html>
